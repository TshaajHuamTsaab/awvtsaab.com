<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>é˜…è¯»å™¨ï¼ˆå®‰å…¨ç‰ˆï¼‰</title>
<style>
  body { font-family: sans-serif; margin: 20px; background: #111; color: #0f0; }
  h1 { text-align: center; }
  .page { display: none; margin-bottom: 20px; }
  .page.active { display: block; }
  #nav { margin-top: 20px; text-align: center; }
  button { 
    margin: 5px; padding: 8px 12px; 
    background: #111; color: #0f0; border: 1px solid #0f0; border-radius: 5px;
    cursor: pointer;
  }
  button:hover { background: #0f0; color: #111; }
  #error { color: red; text-align: center; margin-top: 10px; }
</style>
</head>
<body>
  <button onclick="goBack()">â¬… è¿”å›ç›®å½•</button>
  <h1 id="bookTitle">åŠ è½½ä¸­...</h1>
  <div id="book"></div>
  <div id="error"></div>

  <div id="nav">
    <button onclick="prevPage()">â¬… ä¸Šä¸€é¡µ</button>
    <button onclick="nextPage()">ä¸‹ä¸€é¡µ â¡</button>
    <button onclick="toggleAudio()">ğŸ”Š æ’­æ”¾/æš‚åœ</button>
    <button onclick="goBack()">ğŸ“– è¿”å›ç›®å½•</button>
  </div>

<script>
let currentPage = 0;
let pages = [];
let audio = null;

const urlParams = new URLSearchParams(window.location.search);
const chapterNum = urlParams.get("chapter");

// è¿”å›ç›®å½•
function goBack() {
  window.location.href = "library.html";
}

// åŠ è½½ç« èŠ‚æ–‡å­—
function loadChapter(num) {
  const file = `assets/chapter${num}.txt`;

  fetch(file)
    .then(res => {
      if (!res.ok) throw new Error("æ‰¾ä¸åˆ°æ–‡ä»¶: " + file);
      return res.text();
    })
    .then(text => {
      const chapters = text.split("==="); // å¯ä»¥ç”¨ === åˆ†é¡µ
      const bookDiv = document.getElementById("book");
      bookDiv.innerHTML = "";

      chapters.forEach((chapter, i) => {
        const page = document.createElement("div");
        page.className = "page";
        if (i === 0) page.classList.add("active");
        page.innerHTML = `<pre>${chapter.trim()}</pre>`;
        bookDiv.appendChild(page);
      });

      pages = document.querySelectorAll(".page");
      currentPage = 0;
      document.getElementById("bookTitle").textContent = "æ­£åœ¨é˜…è¯»ï¼šç¬¬ " + num + " ç« ";

      // è‡ªåŠ¨åŠ è½½å¯¹åº”éŸ³é¢‘
      loadAudio(num);
    })
    .catch(err => {
      console.error(err);
      document.getElementById("error").textContent = "âŒ " + err.message;
    });
}

// ç¿»é¡µ
function showPage(n){
  pages.forEach(p => p.classList.remove("active"));
  if (pages[n]) {
    pages[n].classList.add("active");
    currentPage = n;
  }
}
function nextPage(){ if(currentPage < pages.length-1) showPage(currentPage+1); }
function prevPage(){ if(currentPage > 0) showPage(currentPage-1); }

// éŸ³é¢‘æ’­æ”¾
function loadAudio(num) {
  const audioFile = `src/chapter${num}.mp3`; // ä» src æ–‡ä»¶å¤¹åŠ è½½
  audio = new Audio(audioFile);
  audio.onerror = () => {
    document.getElementById("error").textContent = "âŒ æ— æ³•åŠ è½½éŸ³é¢‘: " + audioFile;
  };
}

function toggleAudio() {
  if (!audio) return;
  if (audio.paused) audio.play();
  else audio.pause();
}

// é»˜è®¤åŠ è½½
if (!chapterNum) {
  document.getElementById("bookTitle").textContent = "æœªé€‰æ‹©ç« èŠ‚";
  document.getElementById("book").innerHTML = "<p style='color:red'>âŒ URL ç¼ºå°‘ ?chapter=æ•°å­— å‚æ•°ï¼Œè¯·ä»ç›®å½•é¡µç‚¹å‡»ç« èŠ‚</p>";
} else {
  loadChapter(chapterNum);
}
</script>

</body>
</html>
