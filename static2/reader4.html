<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìñ Awv Reader</title>
  <style>
    :root {
      --bg-primary: #000;
      --bg-secondary: #111;
      --text-primary: #eee;
      --accent-color: #9dfaff;
      --accent-secondary: #90e0ff;
      --button-bg: #00bcd4;
      --button-hover: #00acc1;
      --shadow-color: rgba(0,255,255,0.2);
      --reader-bg: #1a1a1a;
      --reader-border: #333;
    }

    body {
      margin: 0;
      font-family: "Poppins", "Noto Sans SC", sans-serif;
      background: linear-gradient(180deg, var(--bg-primary), var(--bg-secondary));
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: all 0.5s ease;
    }

    header {
      background: var(--bg-secondary);
      padding: 15px;
      text-align: center;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--accent-color);
      box-shadow: 0 2px 10px var(--shadow-color);
      position: relative;
    }

    .theme-selector {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
    }

    .theme-btn {
      background: transparent;
      border: 2px solid var(--accent-color);
      color: var(--accent-color);
      padding: 5px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }

    .theme-btn:hover {
      background: var(--accent-color);
      color: var(--bg-secondary);
    }

    .theme-panel {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--bg-secondary);
      border: 1px solid var(--accent-color);
      border-radius: 10px;
      padding: 15px;
      display: none;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 10px;
      z-index: 1000;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .theme-panel.active {
      display: grid;
    }

    .theme-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .theme-option:hover {
      transform: scale(1.1);
      border-color: white;
    }

    .theme-option.active {
      border-color: white;
      box-shadow: 0 0 10px white;
    }

    #chapterTitle {
      text-align: center;
      margin: 20px 0;
      color: var(--accent-secondary);
      font-size: 1.4rem;
    }

    .reader-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      margin: 0 auto;
      width: 95%;
    }

    .reader-text {
      flex: 1;
      padding: 30px;
      line-height: 1.8;
      font-size: 1.1rem;
      overflow-y: auto;
      transition: color 0.5s ease;
      background: var(--reader-bg);
      border: 2px solid var(--reader-border);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }

    .audio-section, .chapter-nav {
      text-align: center;
      margin: 20px 0;
    }

    /* Âõ∫ÂÆöÂΩ©Ëâ≤ÊåâÈíÆÊ†∑Âºè */
    .fixed-color-btn {
      background: linear-gradient(135deg, #ff6b6b, #ff8e53);
      border: none;
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
      margin: 0 10px;
      box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3);
      font-size: 1rem;
    }

    .fixed-color-btn:hover {
      background: linear-gradient(135deg, #ff5252, #ff7b42);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(255, 107, 107, 0.4);
    }

    .fixed-color-btn:disabled {
      background: linear-gradient(135deg, #aaa, #888);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Èü≥È¢ëÊí≠ÊîæÂô®Ê†∑Âºè */
    .audio-section {
      width: 95%;
      max-width: 800px;
      margin: 20px auto;
    }

    .audio-player {
      display: flex;
      align-items: center;
      gap: 15px;
      background: #111;
      border: 3px solid #00ff00;
      border-radius: 16px;
      padding: 12px 20px;
      box-shadow: 0 0 16px #00ff00;
    }

    .audio-player button {
      background: #1a1a1a;
      color: #00ff00;
      border: 2px solid #00ff00;
      border-radius: 12px;
      padding: 10px 15px;
      cursor: pointer;
      font-size: 1rem;
      transition: 0.2s;
      font-weight: 600;
    }

    .audio-player button:hover {
      background: #00ff00;
      color: #111;
      box-shadow: 0 0 12px #00ff00;
    }

    #audio-progress {
      flex: 1;
      height: 10px;
      border-radius: 5px;
      background: #333;
      cursor: pointer;
      accent-color: #00ff00;
    }

    #audio-time {
      color: #00ff00;
      font-family: monospace;
      font-size: 0.9rem;
      min-width: 100px;
      text-align: center;
      font-weight: 600;
    }

    /* ÈÄüÂ∫¶ÊåâÈíÆÊ†∑Âºè */
    #speed-btn {
      background: #1a1a1a;
      color: #00ff00;
      border: 2px solid #00ff00;
      border-radius: 12px;
      padding: 10px 16px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      user-select: none;
      font-weight: 600;
    }

    #speed-btn:hover {
      background: #00ff00;
      color: #111;
      box-shadow: 0 0 12px #00ff00;
    }

    #speed-btn:active {
      transform: scale(0.95);
      box-shadow: 0 0 6px #00ff00 inset;
    }

    #speed-btn.active {
      background: #00ff00;
      color: #111;
      box-shadow: 0 0 12px #00ff00;
    }

    footer {
      text-align: center;
      background: #0a0a0a;
      padding: 15px;
      font-size: 0.9rem;
      color: #777;
      margin-top: 20px;
    }

    /* ‰∏ªÈ¢òÈ¢úËâ≤ÂÆö‰πâ */
    .theme-default {
      --bg-primary: #000;
      --bg-secondary: #111;
      --text-primary: #eee;
      --accent-color: #9dfaff;
      --accent-secondary: #90e0ff;
      --button-bg: #00bcd4;
      --button-hover: #00acc1;
      --shadow-color: rgba(0,255,255,0.2);
      --reader-bg: #1a1a1a;
      --reader-border: #333;
    }

    .theme-emerald {
      --bg-primary: #001f0f;
      --bg-secondary: #003320;
      --text-primary: #e8fff3;
      --accent-color: #4dffb8;
      --accent-secondary: #80ffcc;
      --button-bg: #00c853;
      --button-hover: #00a844;
      --shadow-color: rgba(77,255,184,0.3);
      --reader-bg: #002a14;
      --reader-border: #005a28;
    }

    .theme-sunset {
      --bg-primary: #1a0f00;
      --bg-secondary: #332100;
      --text-primary: #fff4e6;
      --accent-color: #ffb74d;
      --accent-secondary: #ffcc80;
      --button-bg: #ff9800;
      --button-hover: #e68900;
      --shadow-color: rgba(255,183,77,0.3);
      --reader-bg: #2a1a00;
      --reader-border: #5a3a00;
    }

    .theme-rose {
      --bg-primary: #1f000f;
      --bg-secondary: #33001a;
      --text-primary: #ffe6f2;
      --accent-color: #ff4d94;
      --accent-secondary: #ff80b3;
      --button-bg: #e91e63;
      --button-hover: #d81b60;
      --shadow-color: rgba(255,77,148,0.3);
      --reader-bg: #2a0014;
      --reader-border: #5a0028;
    }

    .theme-purple {
      --bg-primary: #0f001f;
      --bg-secondary: #1a0033;
      --text-primary: #f2e6ff;
      --accent-color: #b74dff;
      --accent-secondary: #cc80ff;
      --button-bg: #9c27b0;
      --button-hover: #8e24aa;
      --shadow-color: rgba(183,77,255,0.3);
      --reader-bg: #1a002a;
      --reader-border: #33005a;
    }

    .theme-gold {
      --bg-primary: #1f1a00;
      --bg-secondary: #332e00;
      --text-primary: #fffce6;
      --accent-color: #ffeb3b;
      --accent-secondary: #fff176;
      --button-bg: #ffc107;
      --button-hover: #ffb300;
      --shadow-color: rgba(255,235,59,0.3);
      --reader-bg: #2a2800;
      --reader-border: #5a5400;
    }

    .theme-ocean {
      --bg-primary: #00101f;
      --bg-secondary: #001f33;
      --text-primary: #e6f7ff;
      --accent-color: #4dccff;
      --accent-secondary: #80deff;
      --button-bg: #2196f3;
      --button-hover: #1e88e5;
      --shadow-color: rgba(77,204,255,0.3);
      --reader-bg: #001a2a;
      --reader-border: #00335a;
    }
  </style>
</head>
<body class="theme-default">
  <header>
    <h1>üìñ Awv's Â•á‰π¶ÈòÖËØªÊú∫</h1>
    <div class="theme-selector">
      <button class="theme-btn">üé® ‰∏ªÈ¢ò</button>
      <div class="theme-panel">
        <div class="theme-option theme-default active" data-theme="default" style="background: linear-gradient(45deg, #000, #111);"></div>
        <div class="theme-option theme-emerald" data-theme="emerald" style="background: linear-gradient(45deg, #001f0f, #003320);"></div>
        <div class="theme-option theme-sunset" data-theme="sunset" style="background: linear-gradient(45deg, #1a0f00, #332100);"></div>
        <div class="theme-option theme-rose" data-theme="rose" style="background: linear-gradient(45deg, #1f000f, #33001a);"></div>
        <div class="theme-option theme-purple" data-theme="purple" style="background: linear-gradient(45deg, #0f001f, #1a0033);"></div>
        <div class="theme-option theme-gold" data-theme="gold" style="background: linear-gradient(45deg, #1f1a00, #332e00);"></div>
        <div class="theme-option theme-ocean" data-theme="ocean" style="background: linear-gradient(45deg, #00101f, #001f33);"></div>
      </div>
    </div>
  </header>

  <div class="reader-container">
    <h2 id="chapterTitle"></h2>
    
    <div class="reader-text"></div>

    <div class="audio-section">
      <div class="audio-player">
        <button id="playBtn">Êí≠Êîæ</button>
        <input type="range" id="audio-progress" min="0" max="100" value="0">
        <span id="audio-time">0:00 / 0:00</span>
        <button id="speed-btn">1x</button>
      </div>
      <audio id="audio" src="" preload="metadata"></audio>
    </div>

    <div class="chapter-nav">
      <button id="prevBtn" class="fixed-color-btn">‰∏ä‰∏ÄÁ´†</button>
      <button id="nextBtn" class="fixed-color-btn">‰∏ã‰∏ÄÁ´†</button>
    </div>
  </div>

  <footer>¬© 2025 Awv's Reading System</footer>

<script>
  // --- URL parameters ---
  const params = new URLSearchParams(window.location.search);
  const category = params.get("category");
  const book = params.get("book");
  let chapter = params.get("chapter") || "cover";

  const titleEl = document.getElementById("chapterTitle");
  const contentEl = document.querySelector(".reader-text");
  const playBtn = document.getElementById("playBtn");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const speedBtn = document.getElementById('speed-btn');
  const audioEl = document.getElementById('audio');
  const progress = document.getElementById('audio-progress');
  const timeEl = document.getElementById('audio-time');

  // --- Theme switcher ---
  const themeBtn = document.querySelector('.theme-btn');
  const themePanel = document.querySelector('.theme-panel');
  const themeOptions = document.querySelectorAll('.theme-option');

  themeBtn.addEventListener('click', e => { 
    e.stopPropagation(); 
    themePanel.classList.toggle('active'); 
  });

  themeOptions.forEach(option => {
    option.addEventListener('click', function() {
      const theme = this.getAttribute('data-theme');
      document.body.className = '';
      document.body.classList.add(`theme-${theme}`);
      themeOptions.forEach(opt => opt.classList.remove('active'));
      this.classList.add('active');
      themePanel.classList.remove('active');
      localStorage.setItem('reader-theme', theme);
    });
  });

  document.addEventListener('click', () => themePanel.classList.remove('active'));

  const savedTheme = localStorage.getItem('reader-theme') || 'default';
  document.body.classList.add(`theme-${savedTheme}`);
  themeOptions.forEach(opt => { 
    if (opt.getAttribute('data-theme') === savedTheme) opt.classList.add('active'); 
  });

  // --- Playback speed control ---
  const speeds = [0.5, 0.75, 1, 1.25, 1.5, 2];
  let currentSpeedIndex = speeds.indexOf(1);

  const savedSpeed = parseFloat(localStorage.getItem('reader-playback-speed')) || 1;
  currentSpeedIndex = speeds.indexOf(savedSpeed);
  audioEl.playbackRate = speeds[currentSpeedIndex];
  speedBtn.textContent = speeds[currentSpeedIndex] + 'x';

  speedBtn.addEventListener('click', () => {
    currentSpeedIndex = (currentSpeedIndex + 1) % speeds.length;
    const newSpeed = speeds[currentSpeedIndex];
    speedBtn.textContent = newSpeed + 'x';
    audioEl.playbackRate = newSpeed;
    localStorage.setItem('reader-playback-speed', newSpeed);
  });

  // --- Dynamic last chapter detection ---
  async function findLastChapter() {
    let n = 1;
    while (true) {
      const path = `assets/${category}/${book}/chapter${n}.html`;
      const res = await fetch(path, { method: "HEAD" });
      if (!res.ok) return n - 1;
      n++;
    }
  }

  let lastChapter = 0;

  // --- Load chapter ---
  async function loadChapter(autoPlay = false) {
    if (lastChapter === 0) lastChapter = await findLastChapter();

    const htmlPath = `assets/${category}/${book}/${chapter}.html`;
    const audioPath = `assets/${category}/${book}/audio/${chapter}.mp3`;

    // --- Load chapter content ---
    try {
      const res = await fetch(htmlPath);
      if (!res.ok) throw new Error();
      const text = await res.text();
      contentEl.innerHTML = text;
    } catch {
      contentEl.innerHTML = `<p style="color:#f88; text-align: center;">‚ùå Êú™ÊâæÂà∞Á´†ËäÇÂÜÖÂÆπ„ÄÇ</p>`;
    }

    // --- Title ---
    titleEl.textContent = chapter === "cover" ? "Â∞ÅÈù¢" : `Á¨¨${parseInt(chapter.replace("chapter",""))}Á´†`;

    // --- Prev / Next buttons ---
    const currentNum = chapter === "cover" ? 0 : parseInt(chapter.replace("chapter",""));
    prevBtn.disabled = currentNum <= 0;
    prevBtn.style.opacity = prevBtn.disabled ? 0.5 : 1;
    prevBtn.style.cursor = prevBtn.disabled ? "not-allowed" : "pointer";

    nextBtn.disabled = currentNum >= lastChapter;
    nextBtn.style.opacity = nextBtn.disabled ? 0.5 : 1;
    nextBtn.style.cursor = nextBtn.disabled ? "not-allowed" : "pointer";

    // --- Audio setup ---
    audioEl.src = audioPath;
    audioEl.load();

    try {
      const res = await fetch(audioPath, { method: "HEAD" });
      if (!res.ok) {
        playBtn.disabled = true;
        playBtn.textContent = "Êó†Èü≥È¢ë";
        audioEl.style.display = "none";
      } else {
        playBtn.disabled = false;
        playBtn.textContent = autoPlay ? "ÊöÇÂÅú" : "Êí≠Êîæ";
        if (autoPlay) audioEl.play().catch(()=>{});
      }
    } catch {
      playBtn.disabled = true;
      playBtn.textContent = "Êó†Èü≥È¢ë";
      audioEl.style.display = "none";
    }
  }

  // --- Initialize ---
  loadChapter();

  // --- Play / Pause ---
  playBtn.addEventListener("click", async () => {
    if (audioEl.paused) {
      await audioEl.play().catch(()=>{});
      playBtn.textContent = "ÊöÇÂÅú";
    } else {
      audioEl.pause();
      playBtn.textContent = "Êí≠Êîæ";
    }
  });

  // --- Audio progress update ---
  audioEl.addEventListener('timeupdate', () => {
    const percent = (audioEl.currentTime / audioEl.duration) * 100 || 0;
    progress.value = percent;

    const formatTime = t => `${Math.floor(t/60)}:${String(Math.floor(t%60)).padStart(2,'0')}`;
    timeEl.textContent = `${formatTime(audioEl.currentTime)} / ${formatTime(audioEl.duration || 0)}`;
  });

  // --- Seek audio ---
  progress.addEventListener('input', () => {
    audioEl.currentTime = (progress.value / 100) * audioEl.duration;
  });

  // --- Auto next chapter on end ---
  audioEl.addEventListener("ended", () => {
    changeChapter(1, true);
  });

  // --- Change chapter ---
  async function changeChapter(step, autoPlayNext = false) {
    const currentNum = chapter === "cover" ? 0 : parseInt(chapter.replace("chapter",""));
    if (lastChapter === 0) lastChapter = await findLastChapter();

    let newNum = currentNum + step;
    if (newNum < 0) newNum = 0;
    if (newNum > lastChapter) return;

    chapter = newNum === 0 ? "cover" : `chapter${newNum}`;
    window.history.replaceState({}, "", `?category=${category}&book=${book}&chapter=${chapter}`);
    loadChapter(autoPlayNext);
  }

  prevBtn.addEventListener("click", () => { if (!prevBtn.disabled) changeChapter(-1); });
  nextBtn.addEventListener("click", () => { if (!nextBtn.disabled) changeChapter(1); });
</script>
</body>
</html>
