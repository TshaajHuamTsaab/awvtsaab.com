<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìñ Awv Reader</title>
  <link rel="stylesheet" href="css/reader4.css" />
  <style>
    :root {
      --bg-primary: #000;
      --bg-secondary: #111;
      --text-primary: #eee;
      --accent-color: #9dfaff;
      --accent-secondary: #90e0ff;
      --button-bg: #00bcd4;
      --button-hover: #00acc1;
      --shadow-color: rgba(0,255,255,0.2);
    }

    body {
      margin: 0;
      font-family: "Poppins", "Noto Sans SC", sans-serif;
      background: linear-gradient(180deg, var(--bg-primary), var(--bg-secondary));
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: all 0.5s ease;
    }

    header {
      background: var(--bg-secondary);
      padding: 15px;
      text-align: center;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--accent-color);
      box-shadow: 0 2px 10px var(--shadow-color);
      position: relative;
    }

    .theme-selector {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
    }

    .theme-btn {
      background: transparent;
      border: 2px solid var(--accent-color);
      color: var(--accent-color);
      padding: 5px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }

    .theme-btn:hover {
      background: var(--accent-color);
      color: var(--bg-secondary);
    }

    .theme-panel {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--bg-secondary);
      border: 1px solid var(--accent-color);
      border-radius: 10px;
      padding: 15px;
      display: none;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 10px;
      z-index: 1000;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .theme-panel.active {
      display: grid;
    }

    .theme-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .theme-option:hover {
      transform: scale(1.1);
      border-color: white;
    }

    .theme-option.active {
      border-color: white;
      box-shadow: 0 0 10px white;
    }

    #chapterTitle {
      text-align: center;
      margin: 20px 0;
      color: var(--accent-secondary);
      font-size: 1.4rem;
    }

    .reader-text {
      flex: 1;
      padding: 20px;
      line-height: 1.8;
      font-size: 1.05rem;
      overflow-y: auto;
      transition: color 0.5s ease;
    }

    .audio-section, .chapter-nav {
      text-align: center;
      margin: 20px 0;
    }

    button {
      background: var(--button-bg);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
      margin: 0 5px;
    }

    button:hover {
      background: var(--button-hover);
    }

    audio {
      width: 70%;
      border-radius: 10px;
      margin-top: 10px;
    }

    footer {
      text-align: center;
      background: #0a0a0a;
      padding: 15px;
      font-size: 0.9rem;
      color: #777;
    }

    /* ‰∏ªÈ¢òÈ¢úËâ≤ÂÆö‰πâ */
    .theme-default {
      --bg-primary: #000;
      --bg-secondary: #111;
      --text-primary: #eee;
      --accent-color: #9dfaff;
      --accent-secondary: #90e0ff;
      --button-bg: #00bcd4;
      --button-hover: #00acc1;
      --shadow-color: rgba(0,255,255,0.2);
    }

    .theme-emerald {
      --bg-primary: #001f0f;
      --bg-secondary: #003320;
      --text-primary: #e8fff3;
      --accent-color: #4dffb8;
      --accent-secondary: #80ffcc;
      --button-bg: #00c853;
      --button-hover: #00a844;
      --shadow-color: rgba(77,255,184,0.3);
    }

    .theme-sunset {
      --bg-primary: #1a0f00;
      --bg-secondary: #332100;
      --text-primary: #fff4e6;
      --accent-color: #ffb74d;
      --accent-secondary: #ffcc80;
      --button-bg: #ff9800;
      --button-hover: #e68900;
      --shadow-color: rgba(255,183,77,0.3);
    }

    .theme-rose {
      --bg-primary: #1f000f;
      --bg-secondary: #33001a;
      --text-primary: #ffe6f2;
      --accent-color: #ff4d94;
      --accent-secondary: #ff80b3;
      --button-bg: #e91e63;
      --button-hover: #d81b60;
      --shadow-color: rgba(255,77,148,0.3);
    }

    .theme-purple {
      --bg-primary: #0f001f;
      --bg-secondary: #1a0033;
      --text-primary: #f2e6ff;
      --accent-color: #b74dff;
      --accent-secondary: #cc80ff;
      --button-bg: #9c27b0;
      --button-hover: #8e24aa;
      --shadow-color: rgba(183,77,255,0.3);
    }

    .theme-gold {
      --bg-primary: #1f1a00;
      --bg-secondary: #332e00;
      --text-primary: #fffce6;
      --accent-color: #ffeb3b;
      --accent-secondary: #fff176;
      --button-bg: #ffc107;
      --button-hover: #ffb300;
      --shadow-color: rgba(255,235,59,0.3);
    }

    .theme-ocean {
      --bg-primary: #00101f;
      --bg-secondary: #001f33;
      --text-primary: #e6f7ff;
      --accent-color: #4dccff;
      --accent-secondary: #80deff;
      --button-bg: #2196f3;
      --button-hover: #1e88e5;
      --shadow-color: rgba(77,204,255,0.3);
    }
  </style>
</head>
<body class="theme-default">
  <header>
    <h1>üìñ Awv's Â•á‰π¶ÈòÖËØªÊú∫</h1>
    <div class="theme-selector">
      <button class="theme-btn">üé® ‰∏ªÈ¢ò</button>
      <div class="theme-panel">
        <div class="theme-option theme-default active" data-theme="default" style="background: linear-gradient(45deg, #000, #111);"></div>
        <div class="theme-option theme-emerald" data-theme="emerald" style="background: linear-gradient(45deg, #001f0f, #003320);"></div>
        <div class="theme-option theme-sunset" data-theme="sunset" style="background: linear-gradient(45deg, #1a0f00, #332100);"></div>
        <div class="theme-option theme-rose" data-theme="rose" style="background: linear-gradient(45deg, #1f000f, #33001a);"></div>
        <div class="theme-option theme-purple" data-theme="purple" style="background: linear-gradient(45deg, #0f001f, #1a0033);"></div>
        <div class="theme-option theme-gold" data-theme="gold" style="background: linear-gradient(45deg, #1f1a00, #332e00);"></div>
        <div class="theme-option theme-ocean" data-theme="ocean" style="background: linear-gradient(45deg, #00101f, #001f33);"></div>
      </div>
    </div>
  </header>

  <h2 id="chapterTitle"></h2>

  <div class="reader-text"></div>

  <div class="audio-section">
    <button id="playBtn" class="play-btn">‚ñ∂Ô∏è Êí≠Êîæ</button><br />
    <audio id="bookAudio" controls></audio>
  </div>

  <div class="chapter-nav">
    <button id="prevBtn">‰∏ä‰∏ÄÁ´†</button>
    <button id="nextBtn">‰∏ã‰∏ÄÁ´†</button>
  </div>

  <footer>¬© 2025 Awv's Reading System</footer>

<script>
  // --- Ëß£Êûê URL ÂèÇÊï∞ ---
  const params = new URLSearchParams(window.location.search);
  const category = params.get("category");
  const book = params.get("book");
  let chapter = params.get("chapter") || "cover";

  const titleEl = document.getElementById("chapterTitle");
  const contentEl = document.querySelector(".reader-text");
  const audioEl = document.getElementById("bookAudio");
  const playBtn = document.getElementById("playBtn");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");

  // --- ‰∏ªÈ¢òÂàáÊç¢ ---
  const themeBtn = document.querySelector('.theme-btn');
  const themePanel = document.querySelector('.theme-panel');
  const themeOptions = document.querySelectorAll('.theme-option');

  themeBtn.addEventListener('click', e => { e.stopPropagation(); themePanel.classList.toggle('active'); });
  themeOptions.forEach(option => {
    option.addEventListener('click', function() {
      const theme = this.getAttribute('data-theme');
      document.body.className = '';
      document.body.classList.add(`theme-${theme}`);
      themeOptions.forEach(opt => opt.classList.remove('active'));
      this.classList.add('active');
      themePanel.classList.remove('active');
      localStorage.setItem('reader-theme', theme);
    });
  });
  document.addEventListener('click', () => themePanel.classList.remove('active'));
  const savedTheme = localStorage.getItem('reader-theme') || 'default';
  document.body.classList.add(`theme-${savedTheme}`);
  themeOptions.forEach(opt => { if (opt.getAttribute('data-theme') === savedTheme) opt.classList.add('active'); });

  // --- Âä®ÊÄÅÊ£ÄÊµã‰π¶ÁöÑÊúÄÂêé‰∏ÄÁ´† ---
  async function findLastChapter() {
    let n = 1;
    while (true) {
      const path = `assets/${category}/${book}/chapter${n}.html`;
      const res = await fetch(path, { method: "HEAD" });
      if (!res.ok) return n - 1;
      n++;
    }
  }

  let lastChapter = 0;

  async function loadChapter(autoPlay = false) {
    if (lastChapter === 0) lastChapter = await findLastChapter(); // È¶ñÊ¨°Ê£ÄÊµã

    const htmlPath = `assets/${category}/${book}/${chapter}.html`;
    const audioPath = `assets/${category}/${book}/audio/${chapter}.mp3`;

    try {
      const res = await fetch(htmlPath);
      if (!res.ok) throw new Error();
      const text = await res.text();
      contentEl.innerHTML = text;
    } catch {
      contentEl.innerHTML = `<p style="color:#f88;">‚ùå Êú™ÊâæÂà∞Á´†ËäÇÂÜÖÂÆπ„ÄÇ</p>`;
    }

    // --- Ê†áÈ¢òËÆæÁΩÆ ---
    titleEl.textContent = chapter === "cover" ? "Â∞ÅÈù¢" : `Á¨¨${parseInt(chapter.replace("chapter",""))}Á´†`;

    // --- ‰∏ä‰∏ÄÁ´† / ‰∏ã‰∏ÄÁ´†ÊéßÂà∂ ---
    const currentNum = chapter === "cover" ? 0 : parseInt(chapter.replace("chapter",""));

    // ‰∏ä‰∏ÄÁ´†
    prevBtn.disabled = currentNum <= 0;
    prevBtn.style.opacity = prevBtn.disabled ? 0.5 : 1;
    prevBtn.style.cursor = prevBtn.disabled ? "not-allowed" : "pointer";

    // ‰∏ã‰∏ÄÁ´†ÔºàË∂ÖÂá∫Êó∂Á¶ÅÁî®Ôºâ
    nextBtn.disabled = currentNum >= lastChapter;
    nextBtn.style.opacity = nextBtn.disabled ? 0.5 : 1;
    nextBtn.style.cursor = nextBtn.disabled ? "not-allowed" : "pointer";

    // --- Èü≥È¢ë ---
    audioEl.src = audioPath;
    audioEl.load();

    fetch(audioPath, { method: "HEAD" })
      .then(res => {
        if (res.ok) {
          playBtn.style.display = "inline-block";
          audioEl.style.display = "inline";
          playBtn.textContent = autoPlay ? "‚è∏Ô∏è ÊöÇÂÅú" : "‚ñ∂Ô∏è Êí≠Êîæ";
          if (autoPlay) audioEl.play().catch(()=>{});
        } else {
          playBtn.style.display = "none";
          audioEl.style.display = "none";
        }
      })
      .catch(() => { playBtn.style.display = "none"; audioEl.style.display = "none"; });
  }

  // --- ÂàùÂßãÂåñ ---
  loadChapter();

  // --- Êí≠Êîæ / ÊöÇÂÅú ---
  playBtn.addEventListener("click", async () => {
    if (audioEl.paused) {
      await audioEl.play().catch(()=>{});
      playBtn.textContent = "‚è∏Ô∏è ÊöÇÂÅú";
    } else {
      audioEl.pause();
      playBtn.textContent = "‚ñ∂Ô∏è Êí≠Êîæ";
    }
  });

  // --- Èü≥È¢ëÁªìÊùüËá™Âä®‰∏ã‰∏ÄÁ´† ---
  audioEl.addEventListener("ended", () => {
    changeChapter(1, true);
  });

  // --- ÂàáÊç¢Á´†ËäÇ ---
  async function changeChapter(step, autoPlayNext = false) {
    const currentNum = chapter === "cover" ? 0 : parseInt(chapter.replace("chapter",""));
    if (lastChapter === 0) lastChapter = await findLastChapter();

    let newNum = currentNum + step;
    if (newNum < 0) newNum = 0;
    if (newNum > lastChapter) return; // ‚ùå ‰∏çË∂ÖÂá∫ÊúÄÂêéÁ´†ËäÇ

    chapter = newNum === 0 ? "cover" : `chapter${newNum}`;
    window.history.replaceState({}, "", `?category=${category}&book=${book}&chapter=${chapter}`);
    loadChapter(autoPlayNext);
  }

  prevBtn.addEventListener("click", () => { if (!prevBtn.disabled) changeChapter(-1); });
  nextBtn.addEventListener("click", () => { if (!nextBtn.disabled) changeChapter(1); });
</script>
</body>
</html>
