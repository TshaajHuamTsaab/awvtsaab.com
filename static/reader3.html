<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Awv'sæ¼†ä¹¦ - é”å±æ’­æ”¾æ”¯æŒ</title>

    <!-- æ ·å¼ä¸å›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="css/reader3.css">

    <!-- PWAé…ç½® -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Awv'sæ¼†ä¹¦">

    <!-- è‹¹æœSafariç‰¹å®šé…ç½® -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <style>
        /* ä¿è¯åˆ‡æ¢æŒ‰é’®å§‹ç»ˆå¯è§ */
        #dj-toggle-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 999;
        }

        /* ä¸ç¡çœ æŒ‰é’® */
        #no-sleep-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 999;
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
        }

        #no-sleep-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

        #no-sleep-btn.active {
            background: linear-gradient(135deg, #00ff88, #0ff);
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.4);
        }

        #no-sleep-btn .btn-text {
            margin-left: 8px;
        }

        /* é”å±æ’­æ”¾æç¤ºæ ·å¼ */
        .background-play-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #00ff88, #0ff);
            color: #000;
            padding: 12px 24px;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.5);
            z-index: 10000;
            display: none;
            align-items: center;
            gap: 12px;
            font-weight: bold;
            font-size: 14px;
            animation: slideInDown 0.5s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .background-play-notification.show { display: flex; }

        @keyframes slideInDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* éšè—éŸ³é¢‘å…ƒç´  */
        #chapter-audio {
            position: absolute;
            left: -9999px;
            opacity: 0;
            pointer-events: none;
            width: 0;
            height: 0;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        .loading-spinner.active { display: block; }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(0, 255, 255, 0.3);
            border-top: 5px solid #0ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }
    </style>
</head>
<body>
    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading-spinner" id="loading-spinner"><div class="spinner"></div></div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div id="bookTitle">åŠ è½½ä¸­...</div>
    <div id="book"></div>
    <div id="error"></div>

    <!-- è£…é¥°å…ƒç´  -->
    <div id="outer-ring"></div>
    <div id="square-rotation"></div>

    <!-- é”å±æ’­æ”¾æç¤º -->
    <div id="background-play-notification" class="background-play-notification">
        <i class="fas fa-headphones"></i>
        <span>é”å±æ’­æ”¾å·²å¯ç”¨ - é”å±åä»å¯ç»§ç»­æ”¶å¬</span>
    </div>

    <!-- ä¸ç¡çœ æŒ‰é’® -->
    <button id="no-sleep-btn" class="dj-btn" title="ä¿æŒå±å¹•å¸¸äº®">
        <i class="fas fa-moon"></i><span class="btn-text">ä¿æŒå¸¸äº®</span>
    </button>

    <!-- DJé£æ ¼æ’­æ”¾æ§åˆ¶å™¨ -->
    <div id="dj-player" class="dj-player">
        <div class="dj-chapter-info">
            <div class="dj-chapter-title" id="dj-chapter-title">åŠ è½½ä¸­...</div>
            <div class="dj-chapter-progress" id="dj-chapter-progress">- / -</div>
        </div>

        <div class="dj-main-controls">
            <button class="dj-btn dj-prev-btn" title="ä¸Šä¸€ç« ">
                <i class="fas fa-backward-step"></i><span class="btn-text">ä¸Šä¸€ç« </span>
            </button>
            <button class="dj-btn dj-play-btn" id="dj-play-btn" title="æ’­æ”¾/æš‚åœ">
                <i class="fas fa-play"></i><span class="btn-text">æ’­æ”¾</span>
            </button>
            <button class="dj-btn dj-next-btn" title="ä¸‹ä¸€ç« ">
                <i class="fas fa-forward-step"></i><span class="btn-text">ä¸‹ä¸€ç« </span>
            </button>
        </div>

        <div class="dj-progress">
            <div class="dj-time-display">
                <span id="dj-current-time">00:00</span>
                <span id="dj-duration">00:00</span>
            </div>
            <div class="dj-progress-bar"><div class="dj-progress-fill" id="dj-progress-fill"></div></div>
        </div>

        <div class="dj-visualizer" id="dj-visualizer"></div>

        <div class="dj-secondary-controls">
            <button class="dj-btn dj-speed-btn" id="dj-speed-btn" title="æ’­æ”¾é€Ÿåº¦">
                <i class="fas fa-gauge-high"></i><span class="btn-text">1x</span>
            </button>
            <button class="dj-btn dj-theme-btn" title="åˆ‡æ¢ä¸»é¢˜">
                <i class="fas fa-palette"></i><span class="btn-text">ä¸»é¢˜</span>
            </button>
            <button class="dj-btn dj-font-btn dj-font-minus" title="å‡å°å­—ä½“">
                <i class="fas fa-font"></i><span class="btn-text">A-</span>
            </button>
            <button class="dj-btn dj-font-btn dj-font-plus" title="å¢å¤§å­—ä½“">
                <i class="fas fa-font"></i><span class="btn-text">A+</span>
            </button>
            <button class="dj-btn dj-home-btn" title="è¿”å›é¦–é¡µ">
                <i class="fas fa-home"></i><span class="btn-text">é¦–é¡µ</span>
            </button>
        </div>
    </div>

    <button id="dj-toggle-btn" class="dj-btn dj-toggle-btn">
        <i class="fas fa-eye"></i><span class="btn-text">æ˜¾ç¤º/éšè—</span>
    </button>

    <!-- éŸ³é¢‘å…ƒç´  -->
    <audio id="chapter-audio" preload="auto" playsinline crossorigin="anonymous"></audio>

    <!-- åŸæœ‰é€»è¾‘ -->
    <script src="js/reader3.js"></script>

    <!-- çº¯å‡€çš„é”å±æ’­æ”¾æ”¯æŒæ ¸å¿ƒä»£ç  -->
    <script>
        // ========== å±å¹•å¸¸äº®æ§åˆ¶æ¨¡å— ==========
        class NoSleepManager {
            constructor() {
                this.isActive = false;
                this.noSleepTimer = null;
                this.videoElement = null;
                this.init();
            }

            init() {
                this.createVideoElement();
                this.setupButton();
            }

            createVideoElement() {
                // åˆ›å»ºä¸€ä¸ªéšè—çš„è§†é¢‘å…ƒç´ æ¥ä¿æŒå±å¹•å”¤é†’
                this.videoElement = document.createElement('video');
                this.videoElement.setAttribute('playsinline', '');
                this.videoElement.setAttribute('webkit-playsinline', '');
                this.videoElement.setAttribute('muted', '');
                this.videoElement.setAttribute('volume', '0');
                this.videoElement.style.display = 'none';
                
                // åˆ›å»ºä¸€ä¸ªé€æ˜çš„1x1åƒç´ è§†é¢‘
                const canvas = document.createElement('canvas');
                canvas.width = 1;
                canvas.height = 1;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, 1, 1);
                
                const stream = canvas.captureStream();
                this.videoElement.srcObject = stream;
                
                document.body.appendChild(this.videoElement);
            }

            setupButton() {
                const button = document.getElementById('no-sleep-btn');
                button.addEventListener('click', () => {
                    this.toggleNoSleep();
                });
            }

            toggleNoSleep() {
                if (this.isActive) {
                    this.disableNoSleep();
                } else {
                    this.enableNoSleep();
                }
            }

            enableNoSleep() {
                if (!this.isActive) {
                    console.log('ğŸ”† å¯ç”¨å±å¹•å¸¸äº®');
                    this.isActive = true;
                    
                    // æ’­æ”¾è§†é¢‘æ¥ä¿æŒå±å¹•å”¤é†’
                    this.videoElement.play().catch(e => {
                        console.log('è§†é¢‘æ’­æ”¾å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ:', e);
                        this.startTimerMethod();
                    });
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    this.updateButtonState();
                    
                    // æ˜¾ç¤ºæç¤º
                    this.showNotification('å±å¹•å¸¸äº®å·²å¯ç”¨');
                }
            }

            disableNoSleep() {
                if (this.isActive) {
                    console.log('ğŸ’¤ å…³é—­å±å¹•å¸¸äº®');
                    this.isActive = false;
                    
                    // åœæ­¢è§†é¢‘
                    this.videoElement.pause();
                    
                    // æ¸…é™¤å®šæ—¶å™¨
                    if (this.noSleepTimer) {
                        clearInterval(this.noSleepTimer);
                        this.noSleepTimer = null;
                    }
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    this.updateButtonState();
                    
                    // æ˜¾ç¤ºæç¤º
                    this.showNotification('å±å¹•å¸¸äº®å·²å…³é—­');
                }
            }

            startTimerMethod() {
                // å¤‡ç”¨æ–¹æ¡ˆï¼šå®šæœŸå‘é€ç”¨æˆ·æ´»åŠ¨ä¿¡å·
                this.noSleepTimer = setInterval(() => {
                    // æ¨¡æ‹Ÿç”¨æˆ·æ´»åŠ¨
                    window.dispatchEvent(new Event('mousemove'));
                    window.dispatchEvent(new Event('keydown'));
                }, 15000); // æ¯15ç§’è§¦å‘ä¸€æ¬¡
            }

            updateButtonState() {
                const button = document.getElementById('no-sleep-btn');
                const icon = button.querySelector('i');
                const text = button.querySelector('.btn-text');
                
                if (this.isActive) {
                    button.classList.add('active');
                    icon.className = 'fas fa-sun';
                    text.textContent = 'å¸¸äº®ä¸­';
                } else {
                    button.classList.remove('active');
                    icon.className = 'fas fa-moon';
                    text.textContent = 'ä¿æŒå¸¸äº®';
                }
            }

            showNotification(message) {
                const notification = document.getElementById('background-play-notification');
                if (notification) {
                    notification.querySelector('span').textContent = message;
                    notification.classList.add('show');
                    
                    setTimeout(() => {
                        notification.classList.remove('show');
                    }, 2000);
                }
            }
        }

        // ========== é”å±æ’­æ”¾æ”¯æŒæ ¸å¿ƒæ¨¡å— ==========
        class LockScreenPlayback {
            constructor() {
                this.audio = document.getElementById('chapter-audio');
                this.noSleepManager = new NoSleepManager();
                this.init();
            }

            init() {
                console.log('ğŸš€ åˆå§‹åŒ–é”å±æ’­æ”¾æ”¯æŒ...');
                
                // åˆå§‹åŒ–åª’ä½“ä¼šè¯ï¼ˆé”å±æ§åˆ¶ï¼‰
                this.initMediaSession();
                
                // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
                this.initEventListeners();
                
                // æ¢å¤æ’­æ”¾çŠ¶æ€
                this.restorePlaybackState();
                
                console.log('âœ… é”å±æ’­æ”¾æ”¯æŒåˆå§‹åŒ–å®Œæˆ');
            }

            // åˆå§‹åŒ–åª’ä½“ä¼šè¯ï¼ˆé”å±æ§åˆ¶ï¼‰
            initMediaSession() {
                if ('mediaSession' in navigator) {
                    this.updateMediaSessionMetadata();
                    
                    // è®¾ç½®é”å±æ§åˆ¶æŒ‰é’®
                    const actions = ['play', 'pause', 'previoustrack', 'nexttrack'];
                    
                    actions.forEach(action => {
                        try {
                            navigator.mediaSession.setActionHandler(action, (details) => {
                                this.handleMediaSessionAction(action, details);
                            });
                        } catch (error) {
                            console.log(`âš ï¸ ${action} åŠ¨ä½œä¸æ”¯æŒ:`, error);
                        }
                    });
                    
                    console.log('âœ… é”å±æ§åˆ¶åˆå§‹åŒ–æˆåŠŸ');
                }
            }

            // å¤„ç†é”å±æ§åˆ¶åŠ¨ä½œ
            handleMediaSessionAction(action, details) {
                console.log('ğŸ“± é”å±æ§åˆ¶åŠ¨ä½œ:', action);
                
                switch (action) {
                    case 'play':
                        this.audio.play().catch(console.error);
                        break;
                    case 'pause':
                        this.audio.pause();
                        break;
                    case 'previoustrack':
                        if (window.ReaderApp && window.ReaderApp.changeChapter) {
                            window.ReaderApp.changeChapter(-1);
                        }
                        break;
                    case 'nexttrack':
                        if (window.ReaderApp && window.ReaderApp.changeChapter) {
                            window.ReaderApp.changeChapter(1);
                        }
                        break;
                }
                
                this.savePlaybackState();
            }

            // æ›´æ–°é”å±æ˜¾ç¤ºä¿¡æ¯
            updateMediaSessionMetadata() {
                if (!('mediaSession' in navigator)) return;
                
                const bookTitle = document.getElementById('bookTitle')?.textContent || 'Awv\'sæ¼†ä¹¦';
                const chapterTitle = document.getElementById('dj-chapter-title')?.textContent || 'å½“å‰ç« èŠ‚';
                
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: `${bookTitle} - ${chapterTitle}`,
                    artist: 'Awv\'sæ¼†ä¹¦æœ—è¯»å™¨',
                    album: 'ç”µå­ä¹¦éŸ³é¢‘',
                    artwork: [
                        { src: 'icons/icon-192x192.png', sizes: '192x192', type: 'image/png' },
                        { src: 'icons/icon-512x512.png', sizes: '512x512', type: 'image/png' }
                    ]
                });
            }

            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
            initEventListeners() {
                // é¡µé¢å¯è§æ€§å˜åŒ–ï¼ˆé”å±/åˆ‡æ¢åº”ç”¨ï¼‰
                document.addEventListener('visibilitychange', () => {
                    this.handleVisibilityChange();
                });

                // éŸ³é¢‘æ’­æ”¾çŠ¶æ€
                this.audio.addEventListener('play', () => {
                    this.handleAudioPlay();
                });

                this.audio.addEventListener('pause', () => {
                    this.handleAudioPause();
                });

                // å®šæœŸä¿å­˜æ’­æ”¾çŠ¶æ€
                setInterval(() => {
                    this.savePlaybackState();
                }, 10000);

                // é¡µé¢å¸è½½å‰ä¿å­˜çŠ¶æ€
                window.addEventListener('beforeunload', () => {
                    this.savePlaybackState();
                });
            }

            // å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–ï¼ˆé”å±ï¼‰
            handleVisibilityChange() {
                if (document.hidden) {
                    // é¡µé¢è¿›å…¥åå°ï¼ˆé”å±ã€åˆ‡æ¢åº”ç”¨ç­‰ï¼‰
                    console.log('ğŸ“± é¡µé¢è¿›å…¥åå°ï¼Œé”å±æ’­æ”¾å·²å¯ç”¨');
                    this.showLockScreenNotification();
                    
                    // ç¡®ä¿éŸ³é¢‘ç»§ç»­æ’­æ”¾ - ä¸è¿›è¡Œä»»ä½•å¹²é¢„ï¼Œè®©ç³»ç»Ÿè‡ªç„¶å¤„ç†
                } else {
                    // é¡µé¢å›åˆ°å‰å°
                    console.log('ğŸ“± é¡µé¢å›åˆ°å‰å°');
                    this.hideLockScreenNotification();
                }
            }

            // å¤„ç†éŸ³é¢‘æ’­æ”¾
            handleAudioPlay() {
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.playbackState = 'playing';
                }
                this.savePlaybackState();
            }

            // å¤„ç†éŸ³é¢‘æš‚åœ
            handleAudioPause() {
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.playbackState = 'paused';
                }
                this.savePlaybackState();
            }

            // æ˜¾ç¤ºé”å±æ’­æ”¾é€šçŸ¥
            showLockScreenNotification() {
                const notification = document.getElementById('background-play-notification');
                if (notification) {
                    notification.querySelector('span').textContent = 'é”å±æ’­æ”¾å·²å¯ç”¨ - é”å±åä»å¯ç»§ç»­æ”¶å¬';
                    notification.classList.add('show');
                    
                    setTimeout(() => {
                        notification.classList.remove('show');
                    }, 3000);
                }
            }

            // éšè—é”å±æ’­æ”¾é€šçŸ¥
            hideLockScreenNotification() {
                const notification = document.getElementById('background-play-notification');
                if (notification) {
                    notification.classList.remove('show');
                }
            }

            // ä¿å­˜æ’­æ”¾çŠ¶æ€
            savePlaybackState() {
                const playbackState = {
                    currentTime: this.audio.currentTime,
                    isPlaying: !this.audio.paused,
                    playbackRate: this.audio.playbackRate,
                    volume: this.audio.volume,
                    timestamp: Date.now(),
                    book: window.bookFolder || 'dev1',
                    chapter: window.chapterNum || 'cover'
                };
                
                localStorage.setItem('lockScreenPlayState', JSON.stringify(playbackState));
            }

            // æ¢å¤æ’­æ”¾çŠ¶æ€
            restorePlaybackState() {
                try {
                    const savedState = localStorage.getItem('lockScreenPlayState');
                    if (savedState) {
                        const state = JSON.parse(savedState);
                        
                        // æ£€æŸ¥çŠ¶æ€æ˜¯å¦è¿‡æœŸï¼ˆè¶…è¿‡1å°æ—¶ï¼‰
                        const isExpired = (Date.now() - state.timestamp) > 3600000;
                        
                        if (!isExpired) {
                            // æ¢å¤æ’­æ”¾ä½ç½®å’Œè®¾ç½®
                            this.audio.currentTime = state.currentTime || 0;
                            this.audio.playbackRate = state.playbackRate || 1;
                            this.audio.volume = state.volume || 1;
                            
                            console.log('ğŸµ æ’­æ”¾çŠ¶æ€æ¢å¤æˆåŠŸ');
                        }
                    }
                } catch (err) {
                    console.error('æ¢å¤æ’­æ”¾çŠ¶æ€å¤±è´¥:', err);
                }
            }
        }

        // ========== é¡µé¢åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', function() {
            // åˆ›å»ºé”å±æ’­æ”¾ç®¡ç†å™¨å®ä¾‹
            window.lockScreenPlayback = new LockScreenPlayback();
            
            // æš´éœ²æ›´æ–°åª’ä½“å…ƒæ•°æ®çš„æ–¹æ³•
            window.updateMediaSessionMetadata = function() {
                if (window.lockScreenPlayback) {
                    window.lockScreenPlayback.updateMediaSessionMetadata();
                }
            };
        });

        // ========== Service Worker æ³¨å†Œ ==========
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('âœ… ServiceWorker æ³¨å†ŒæˆåŠŸ:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('âŒ ServiceWorker æ³¨å†Œå¤±è´¥:', error);
                    });
            });
        }

    </script>
</body>
</html>
