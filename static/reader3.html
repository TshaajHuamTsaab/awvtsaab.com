<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Awv'sæ¼†ä¹¦ - æ”¯æŒé»‘å±æ’­æ”¾</title>

    <!-- æ ·å¼ä¸å›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="css/reader3.css">

    <!-- PWAé…ç½® -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">

    <style>
        /* ä¿è¯åˆ‡æ¢æŒ‰é’®å§‹ç»ˆå¯è§ */
        #dj-toggle-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 999;
        }

        /* é»‘å±æ’­æ”¾æç¤ºæ ·å¼ */
        .background-play-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #00ff88, #0ff);
            color: #000;
            padding: 12px 24px;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.5);
            z-index: 10000;
            display: none;
            align-items: center;
            gap: 12px;
            font-weight: bold;
            font-size: 14px;
            animation: slideInDown 0.5s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .background-play-notification.show { display: flex; }

        @keyframes slideInDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* éšè—éŸ³é¢‘å…ƒç´  */
        #chapter-audio {
            position: absolute;
            left: -9999px;
            opacity: 0;
            pointer-events: none;
            width: 0;
            height: 0;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        .loading-spinner.active { display: block; }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(0, 255, 255, 0.3);
            border-top: 5px solid #0ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }
    </style>
</head>
<body>
    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading-spinner" id="loading-spinner"><div class="spinner"></div></div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div id="bookTitle">åŠ è½½ä¸­...</div>
    <div id="book"></div>
    <div id="error"></div>

    <!-- è£…é¥°å…ƒç´  -->
    <div id="outer-ring"></div>
    <div id="square-rotation"></div>

    <!-- é»‘å±æ’­æ”¾æç¤º -->
    <div id="background-play-notification" class="background-play-notification">
        <i class="fas fa-headphones"></i>
        <span>é»‘å±æ’­æ”¾å·²å¯ç”¨ - é”å±åä»å¯ç»§ç»­æ”¶å¬</span>
    </div>

    <!-- DJé£æ ¼æ’­æ”¾æ§åˆ¶å™¨ -->
    <div id="dj-player" class="dj-player">
        <div class="dj-chapter-info">
            <div class="dj-chapter-title" id="dj-chapter-title">åŠ è½½ä¸­...</div>
            <div class="dj-chapter-progress" id="dj-chapter-progress">- / -</div>
        </div>

        <div class="dj-main-controls">
            <button class="dj-btn dj-prev-btn" title="ä¸Šä¸€ç« ">
                <i class="fas fa-backward-step"></i><span class="btn-text">ä¸Šä¸€ç« </span>
            </button>
            <button class="dj-btn dj-play-btn" id="dj-play-btn" title="æ’­æ”¾/æš‚åœ">
                <i class="fas fa-play"></i><span class="btn-text">æ’­æ”¾</span>
            </button>
            <button class="dj-btn dj-next-btn" title="ä¸‹ä¸€ç« ">
                <i class="fas fa-forward-step"></i><span class="btn-text">ä¸‹ä¸€ç« </span>
            </button>
        </div>

        <div class="dj-progress">
            <div class="dj-time-display">
                <span id="dj-current-time">00:00</span>
                <span id="dj-duration">00:00</span>
            </div>
            <div class="dj-progress-bar"><div class="dj-progress-fill" id="dj-progress-fill"></div></div>
        </div>

        <div class="dj-visualizer" id="dj-visualizer"></div>

        <div class="dj-secondary-controls">
            <button class="dj-btn dj-speed-btn" id="dj-speed-btn" title="æ’­æ”¾é€Ÿåº¦">
                <i class="fas fa-gauge-high"></i><span class="btn-text">1x</span>
            </button>
            <button class="dj-btn dj-theme-btn" title="åˆ‡æ¢ä¸»é¢˜">
                <i class="fas fa-palette"></i><span class="btn-text">ä¸»é¢˜</span>
            </button>
            <button class="dj-btn dj-font-btn dj-font-minus" title="å‡å°å­—ä½“">
                <i class="fas fa-font"></i><span class="btn-text">A-</span>
            </button>
            <button class="dj-btn dj-font-btn dj-font-plus" title="å¢å¤§å­—ä½“">
                <i class="fas fa-font"></i><span class="btn-text">A+</span>
            </button>
            <button class="dj-btn dj-home-btn" title="è¿”å›é¦–é¡µ">
                <i class="fas fa-home"></i><span class="btn-text">é¦–é¡µ</span>
            </button>
        </div>
    </div>

    <button id="dj-toggle-btn" class="dj-btn dj-toggle-btn">
        <i class="fas fa-eye"></i><span class="btn-text">æ˜¾ç¤º/éšè—</span>
    </button>

    <!-- éŸ³é¢‘å…ƒç´  -->
    <audio id="chapter-audio" preload="auto" playsinline crossorigin="anonymous"></audio>

    <!-- åŸæœ‰é€»è¾‘ -->
    <script src="js/reader3.js"></script>

    <!-- Service Worker æ³¨å†Œ + é»‘å±æ’­æ”¾å¢å¼º -->
    <script>
        // æ³¨å†ŒService Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('ServiceWorker æ³¨å†ŒæˆåŠŸ:', reg.scope))
                    .catch(err => console.log('ServiceWorker æ³¨å†Œå¤±è´¥:', err));
            });
        }

        // é»‘å±æ’­æ”¾æ”¯æŒæ£€æµ‹
        function checkBackgroundPlaySupport() {
            const support = {
                mediaSession: 'mediaSession' in navigator,
                serviceWorker: 'serviceWorker' in navigator,
                wakeLock: 'wakeLock' in navigator,
                backgroundPlay: true
            };
            console.log('é»‘å±æ’­æ”¾æ”¯æŒæ£€æµ‹:', support);
            return support;
        }

        // åˆå§‹åŒ–é»‘å±æ’­æ”¾åŠŸèƒ½
        function initBackgroundPlayback() {
            console.log('ğŸ§ åˆå§‹åŒ–é»‘å±æ’­æ”¾åŠŸèƒ½...');
            
            const audio = document.getElementById('chapter-audio');
            const notification = document.getElementById('background-play-notification');
            
            if (!audio) return;

            // è®¾ç½®Media Session APIï¼ˆé”å±æ§åˆ¶ï¼‰
            if ('mediaSession' in navigator) {
                updateMediaSessionMetadata();
                
                // è®¾ç½®é”å±æ§åˆ¶æŒ‰é’®
                navigator.mediaSession.setActionHandler('play', () => {
                    audio.play().catch(console.error);
                });
                
                navigator.mediaSession.setActionHandler('pause', () => {
                    audio.pause();
                });
                
                navigator.mediaSession.setActionHandler('previoustrack', () => {
                    // ä¸Šä¸€ç« é€»è¾‘
                    if (window.ReaderApp && window.ReaderApp.changeChapter) {
                        window.ReaderApp.changeChapter(-1);
                    }
                });
                
                navigator.mediaSession.setActionHandler('nexttrack', () => {
                    // ä¸‹ä¸€ç« é€»è¾‘
                    if (window.ReaderApp && window.ReaderApp.changeChapter) {
                        window.ReaderApp.changeChapter(1);
                    }
                });

                console.log('ğŸ“± Media Session API åˆå§‹åŒ–æˆåŠŸ');
            }

            // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // é¡µé¢è¿›å…¥åå°ï¼ˆåˆ‡æ¢æ ‡ç­¾é¡µã€é”å±ç­‰ï¼‰
                    console.log('ğŸ“± é¡µé¢è¿›å…¥åå°ï¼ŒéŸ³é¢‘ç»§ç»­æ’­æ”¾');
                    if (notification) {
                        notification.classList.add('show');
                        setTimeout(() => notification.classList.remove('show'), 3000);
                    }
                    
                    // ç¡®ä¿éŸ³é¢‘ç»§ç»­æ’­æ”¾
                    if (!audio.paused) {
                        // ä¿å­˜æ’­æ”¾çŠ¶æ€
                        localStorage.setItem('backgroundPlayState', 'playing');
                    }
                } else {
                    // é¡µé¢å›åˆ°å‰å°
                    console.log('ğŸ“± é¡µé¢å›åˆ°å‰å°');
                    if (notification) {
                        notification.classList.remove('show');
                    }
                }
            });

            // ç›‘å¬éŸ³é¢‘æ’­æ”¾çŠ¶æ€
            audio.addEventListener('play', () => {
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.playbackState = 'playing';
                }
                // ä¿å­˜æ’­æ”¾çŠ¶æ€
                savePlaybackState();
            });

            audio.addEventListener('pause', () => {
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.playbackState = 'paused';
                }
                // ä¿å­˜æ’­æ”¾çŠ¶æ€
                savePlaybackState();
            });

            // å®šæœŸä¿å­˜æ’­æ”¾çŠ¶æ€
            setInterval(savePlaybackState, 10000);

            console.log('âœ… é»‘å±æ’­æ”¾åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
        }

        // æ›´æ–°Media Sessionå…ƒæ•°æ®
        function updateMediaSessionMetadata() {
            if (!('mediaSession' in navigator)) return;
            
            const bookTitle = document.getElementById('bookTitle')?.textContent || 'Awv\'sæ¼†ä¹¦';
            const chapterTitle = document.getElementById('dj-chapter-title')?.textContent || 'å½“å‰ç« èŠ‚';
            
            navigator.mediaSession.metadata = new MediaMetadata({
                title: `${bookTitle} - ${chapterTitle}`,
                artist: 'Awv\'sæ¼†ä¹¦æœ—è¯»å™¨',
                album: 'ç”µå­ä¹¦éŸ³é¢‘',
                artwork: [
                    { src: 'icons/icon-192x192.png', sizes: '192x192', type: 'image/png' },
                    { src: 'icons/icon-512x512.png', sizes: '512x512', type: 'image/png' }
                ]
            });
        }

        // ä¿å­˜æ’­æ”¾çŠ¶æ€
        function savePlaybackState() {
            const audio = document.getElementById('chapter-audio');
            if (!audio) return;
            
            const playbackState = {
                currentTime: audio.currentTime,
                isPlaying: !audio.paused,
                timestamp: Date.now()
            };
            
            localStorage.setItem('playbackState', JSON.stringify(playbackState));
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            checkBackgroundPlaySupport();
            initBackgroundPlayback();
            
            // æš´éœ²æ›´æ–°åª’ä½“å…ƒæ•°æ®çš„æ–¹æ³•
            window.updateMediaSessionMetadata = updateMediaSessionMetadata;
        });

        // ç›‘å¬åœ¨çº¿çŠ¶æ€å˜åŒ–
        window.addEventListener('online', () => {
            console.log('ğŸ“¶ ç½‘ç»œè¿æ¥æ¢å¤');
        });

        window.addEventListener('offline', () => {
            console.log('ğŸ“¶ ç½‘ç»œè¿æ¥æ–­å¼€');
            const errorDiv = document.getElementById('error');
            if (errorDiv) {
                const oldMessage = errorDiv.textContent;
                errorDiv.textContent = 'ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œä½†éŸ³é¢‘æ’­æ”¾ä¸å—å½±å“';
                setTimeout(() => {
                    if (errorDiv.textContent === 'ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œä½†éŸ³é¢‘æ’­æ”¾ä¸å—å½±å“') {
                        errorDiv.textContent = oldMessage;
                    }
                }, 3000);
            }
        });

    </script>
</body>
</html>
