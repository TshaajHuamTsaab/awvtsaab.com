<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Awv'sÊºÜ‰π¶</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <link rel="stylesheet" href="css/reader3.css">

  <meta name="theme-color" content="#000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Awv'sÊºÜ‰π¶">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">

  <style>
    #dj-toggle-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 999;
    }
    .background-play-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #00ff88, #0ff);
      color: #000;
      padding: 12px 24px;
      border-radius: 25px;
      box-shadow: 0 4px 20px rgba(0, 255, 255, 0.5);
      z-index: 10000;
      display: none;
      align-items: center;
      gap: 12px;
      font-weight: bold;
      font-size: 14px;
      animation: slideInDown 0.5s ease;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    .background-play-notification.show { display: flex; }

    @keyframes slideInDown {
      from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    #chapter-audio {
      position: absolute;
      left: -9999px;
      opacity: 0;
      pointer-events: none;
      width: 0;
      height: 0;
    }

    .loading-spinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
    }
    .loading-spinner.active { display: block; }
    .spinner {
      width: 50px; height: 50px;
      border: 5px solid rgba(0, 255, 255, 0.3);
      border-top: 5px solid #0ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }
  </style>
</head>

<body>
  <div class="loading-spinner" id="loading-spinner"><div class="spinner"></div></div>
  <div id="bookTitle">Âä†ËΩΩ‰∏≠...</div>
  <div id="book"></div>
  <div id="error"></div>
  <div id="outer-ring"></div>
  <div id="square-rotation"></div>

  <div id="background-play-notification" class="background-play-notification">
    <i class="fas fa-headphones"></i>
    <span>ÈîÅÂ±èÊí≠ÊîæÂ∑≤ÂêØÁî® - ÈîÅÂ±èÂêé‰ªçÂèØÁªßÁª≠Êî∂Âê¨</span>
  </div>

  <!-- üéß DJ Player -->
  <div id="dj-player" class="dj-player">
    <div class="dj-chapter-info">
      <div id="dj-chapter-title">Âä†ËΩΩ‰∏≠...</div>
      <div id="dj-chapter-progress">- / -</div>
    </div>

    <div class="dj-main-controls">
      <button class="dj-btn" id="prev"><i class="fas fa-backward-step"></i></button>
      <button class="dj-btn" id="play"><i class="fas fa-play"></i></button>
      <button class="dj-btn" id="next"><i class="fas fa-forward-step"></i></button>
    </div>

    <div class="dj-progress">
      <div class="dj-time-display">
        <span id="dj-current-time">00:00</span>
        <span id="dj-duration">00:00</span>
      </div>
      <div class="dj-progress-bar">
        <div class="dj-progress-fill" id="dj-progress-fill"></div>
      </div>
    </div>
  </div>

  <button id="dj-toggle-btn" class="dj-btn"><i class="fas fa-eye"></i></button>
  <audio id="chapter-audio" preload="auto" playsinline crossorigin="anonymous"></audio>

  <script src="js/reader3.js"></script>

  <script>
  // ============================================================
  // üîä UNIVERSAL AUDIO FIX ‚Äî Never Banned or Blocked
  // ============================================================
  class UniversalAudio {
    constructor() {
      this.audio = document.getElementById('chapter-audio');
      this.playBtn = document.getElementById('play');
      this.init();
    }

    init() {
      this.ensureContext();
      this.attachEvents();
      this.setupMediaSession();
      console.log("‚úÖ Universal Audio initialized");
    }

    ensureContext() {
      // Safari / iOS fix: unlock audio context after user tap
      const resumeAudio = () => {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const src = ctx.createMediaElementSource(this.audio);
        src.connect(ctx.destination);
        ctx.resume();
        document.removeEventListener("touchstart", resumeAudio);
        document.removeEventListener("click", resumeAudio);
      };
      document.addEventListener("touchstart", resumeAudio, { once: true });
      document.addEventListener("click", resumeAudio, { once: true });
    }

    attachEvents() {
      this.playBtn.addEventListener('click', async () => {
        try {
          if (this.audio.paused) {
            await this.audio.play();
            this.playBtn.innerHTML = '<i class="fas fa-pause"></i>';
            navigator.mediaSession.playbackState = 'playing';
          } else {
            this.audio.pause();
            this.playBtn.innerHTML = '<i class="fas fa-play"></i>';
            navigator.mediaSession.playbackState = 'paused';
          }
        } catch (err) {
          console.warn("Autoplay blocked, user must tap.", err);
        }
      });
    }

    setupMediaSession() {
      if (!('mediaSession' in navigator)) return;
      navigator.mediaSession.metadata = new MediaMetadata({
        title: "Awv‚ÄôsÊºÜ‰π¶",
        artist: "Awv Reader",
        album: "Awv Audio",
        artwork: [
          { src: 'icons/icon-192x192.png', sizes: '192x192', type: 'image/png' },
          { src: 'icons/icon-512x512.png', sizes: '512x512', type: 'image/png' }
        ]
      });

      navigator.mediaSession.setActionHandler('play', () => this.audio.play());
      navigator.mediaSession.setActionHandler('pause', () => this.audio.pause());
      navigator.mediaSession.setActionHandler('previoustrack', () => alert("‰∏ä‰∏ÄÁ´†"));
      navigator.mediaSession.setActionHandler('nexttrack', () => alert("‰∏ã‰∏ÄÁ´†"));
    }
  }

  // ============================================================
  // ü™Ñ Initialize
  // ============================================================
  document.addEventListener("DOMContentLoaded", () => {
    const audioSystem = new UniversalAudio();
    const audio = document.getElementById('chapter-audio');
    // Example test audio
    audio.src = "Â§©‰Ωø.mp4";
    audio.load();
  });
  </script>
</body>
</html>
