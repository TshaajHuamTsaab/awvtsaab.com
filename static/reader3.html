<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Awv's漆书 - 锁屏播放支持</title>

  <!-- Styles & icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <link rel="stylesheet" href="css/reader3.css">

  <!-- PWA configuration -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Awv's漆书">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background-color: #000;
      color: #fff;
    }
    #dj-toggle-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 999;
    }
    .background-play-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      align-items: center;
      gap: 10px;
      background: linear-gradient(135deg,#00ff88,#0ff);
      color: #000;
      padding: 12px 24px;
      border-radius: 25px;
      box-shadow: 0 4px 20px rgba(0,255,255,0.5);
      border: 2px solid rgba(255,255,255,0.2);
      font-weight: bold;
      z-index: 10000;
      animation: slideInDown .4s ease;
    }
    .background-play-notification.show { display: flex; }
    @keyframes slideInDown {
      from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    #chapter-audio {
      display: none;
    }
    .loading-spinner {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%,-50%);
      z-index: 9999;
    }
    .loading-spinner.active { display: block; }
    .spinner {
      width: 50px; height: 50px;
      border: 5px solid rgba(0,255,255,0.3);
      border-top: 5px solid #0ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to {transform: rotate(360deg);} }
  </style>
</head>
<body>
  <!-- Loading spinner -->
  <div class="loading-spinner" id="loading-spinner"><div class="spinner"></div></div>

  <!-- Content -->
  <div id="bookTitle">加载中...</div>
  <div id="book"></div>
  <div id="error"></div>

  <!-- Decorative elements -->
  <div id="outer-ring"></div>
  <div id="square-rotation"></div>

  <!-- Lock screen playback notification -->
  <div id="background-play-notification" class="background-play-notification">
    <i class="fas fa-headphones"></i>
    <span>锁屏播放已启用 - 锁屏后仍可继续收听</span>
  </div>

  <!-- DJ Player -->
  <div id="dj-player" class="dj-player">
    <div class="dj-chapter-info">
      <div id="dj-chapter-title">加载中...</div>
      <div id="dj-chapter-progress">- / -</div>
    </div>

    <div class="dj-main-controls">
      <button class="dj-btn dj-prev-btn" title="上一章"><i class="fas fa-backward-step"></i></button>
      <button class="dj-btn dj-play-btn" id="dj-play-btn" title="播放/暂停"><i class="fas fa-play"></i></button>
      <button class="dj-btn dj-next-btn" title="下一章"><i class="fas fa-forward-step"></i></button>
    </div>

    <div class="dj-progress">
      <div class="dj-time-display">
        <span id="dj-current-time">00:00</span>
        <span id="dj-duration">00:00</span>
      </div>
      <div class="dj-progress-bar"><div class="dj-progress-fill" id="dj-progress-fill"></div></div>
    </div>

    <div class="dj-visualizer" id="dj-visualizer"></div>

    <div class="dj-secondary-controls">
      <button class="dj-btn" id="dj-speed-btn" title="播放速度"><i class="fas fa-gauge-high"></i><span>1x</span></button>
      <button class="dj-btn" id="dj-theme-btn" title="切换主题"><i class="fas fa-palette"></i></button>
      <button class="dj-btn" id="dj-font-minus" title="减小字体"><i class="fas fa-font"></i></button>
      <button class="dj-btn" id="dj-font-plus" title="增大字体"><i class="fas fa-font"></i></button>
      <button class="dj-btn" id="dj-home-btn" title="首页"><i class="fas fa-home"></i></button>
    </div>
  </div>

  <button id="dj-toggle-btn" class="dj-btn"><i class="fas fa-eye"></i> 显示/隐藏</button>

  <!-- Audio element -->
  <audio id="chapter-audio" preload="auto" playsinline crossorigin="anonymous"></audio>

  <!-- Reader logic -->
  <script src="js/reader3.js"></script>

  <!-- Lock screen playback -->
  <script>
    class LockScreenPlayback {
      constructor() {
        this.audio = document.getElementById('chapter-audio');
        this.notification = document.getElementById('background-play-notification');
        this.init();
      }

      init() {
        this.initMediaSession();
        this.bindEvents();
        this.restoreState();
      }

      initMediaSession() {
        if (!('mediaSession' in navigator)) return;
        this.updateMetadata();
        ['play', 'pause', 'previoustrack', 'nexttrack'].forEach(action => {
          try {
            navigator.mediaSession.setActionHandler(action, () => this.handleAction(action));
          } catch {}
        });
      }

      updateMetadata() {
        if (!('mediaSession' in navigator)) return;
        navigator.mediaSession.metadata = new MediaMetadata({
          title: `${document.getElementById('bookTitle')?.textContent || '漆书'} - ${document.getElementById('dj-chapter-title')?.textContent || ''}`,
          artist: "Awv's漆书朗读器",
          album: "电子书音频",
          artwork: [
            { src: 'icons/icon-192x192.png', sizes: '192x192', type: 'image/png' },
            { src: 'icons/icon-512x512.png', sizes: '512x512', type: 'image/png' }
          ]
        });
      }

      handleAction(action) {
        switch (action) {
          case 'play': this.audio.play(); break;
          case 'pause': this.audio.pause(); break;
          case 'previoustrack': window.ReaderApp?.changeChapter(-1); break;
          case 'nexttrack': window.ReaderApp?.changeChapter(1); break;
        }
        this.saveState();
      }

      bindEvents() {
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) this.showNotification();
          else this.hideNotification();
        });
        this.audio.addEventListener('play', () => this.setPlaybackState('playing'));
        this.audio.addEventListener('pause', () => this.setPlaybackState('paused'));
        window.addEventListener('beforeunload', () => this.saveState());
        setInterval(() => this.saveState(), 10000);
      }

      setPlaybackState(state) {
        if ('mediaSession' in navigator) navigator.mediaSession.playbackState = state;
        this.saveState();
      }

      showNotification() {
        this.notification?.classList.add('show');
        setTimeout(() => this.notification?.classList.remove('show'), 3000);
      }

      hideNotification() {
        this.notification?.classList.remove('show');
      }

      saveState() {
        const a = this.audio;
        localStorage.setItem('playState', JSON.stringify({
          currentTime: a.currentTime,
          isPlaying: !a.paused,
          rate: a.playbackRate,
          volume: a.volume,
          timestamp: Date.now(),
          book: window.bookFolder || '',
          chapter: window.chapterNum || ''
        }));
      }

      restoreState() {
        try {
          const saved = JSON.parse(localStorage.getItem('playState'));
          if (!saved) return;
          if (Date.now() - saved.timestamp > 3600000) return; // 1 hour
          const a = this.audio;
          a.currentTime = saved.currentTime || 0;
          a.playbackRate = saved.rate || 1;
          a.volume = saved.volume || 1;
        } catch {}
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      window.lockScreenPlayback = new LockScreenPlayback();
      window.updateMediaSessionMetadata = () => window.lockScreenPlayback.updateMetadata();
    });

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').then(r => {
          console.log('Service Worker 注册成功:', r.scope);
        }).catch(console.error);
      });
    }
  </script>
</body>
</html>
