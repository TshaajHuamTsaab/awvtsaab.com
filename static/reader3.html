<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Awv'sæ¼†ä¹¦</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="css/reader3.css">

    <!-- PWAé…ç½® -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Awv'sæ¼†ä¹¦">

    <!-- è‹¹æœSafariç‰¹å®šé…ç½® -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <style>
        /* ä¿è¯åˆ‡æ¢æŒ‰é’®å§‹ç»ˆå¯è§ */
        #dj-toggle-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 999;
        }

        /* é”å±æ’­æ”¾æç¤ºæ ·å¼ */
        .background-play-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #00ff88, #0ff);
            color: #000;
            padding: 12px 24px;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.5);
            z-index: 10000;
            display: none;
            align-items: center;
            gap: 12px;
            font-weight: bold;
            font-size: 14px;
            animation: slideInDown 0.5s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .background-play-notification.show { display: flex; }

        @keyframes slideInDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* éšè—éŸ³é¢‘å…ƒç´  */
        #chapter-audio {
            position: absolute;
            left: -9999px;
            opacity: 0;
            pointer-events: none;
            width: 0;
            height: 0;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        .loading-spinner.active { display: block; }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(0, 255, 255, 0.3);
            border-top: 5px solid #0ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }
    </style>
</head>
<body>
    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading-spinner" id="loading-spinner"><div class="spinner"></div></div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div id="bookTitle">åŠ è½½ä¸­...</div>
    <div id="book"></div>
    <div id="error"></div>

    <!-- è£…é¥°å…ƒç´  -->
    <div id="outer-ring"></div>
    <div id="square-rotation"></div>

    <!-- é”å±æ’­æ”¾æç¤º -->
    <div id="background-play-notification" class="background-play-notification">
        <i class="fas fa-headphones"></i>
        <span>é”å±æ’­æ”¾å·²å¯ç”¨ - é”å±åä»å¯ç»§ç»­æ”¶å¬</span>
    </div>

    <!-- DJé£æ ¼æ’­æ”¾æ§åˆ¶å™¨ -->
    <div id="dj-player" class="dj-player">
        <div class="dj-chapter-info">
            <div class="dj-chapter-title" id="dj-chapter-title">åŠ è½½ä¸­...</div>
            <div class="dj-chapter-progress" id="dj-chapter-progress">- / -</div>
        </div>

        <div class="dj-main-controls">
            <button class="dj-btn dj-prev-btn" title="ä¸Šä¸€ç« ">
                <i class="fas fa-backward-step"></i><span class="btn-text">ä¸Šä¸€ç« </span>
            </button>
            <button class="dj-btn dj-play-btn" id="dj-play-btn" title="æ’­æ”¾/æš‚åœ">
                <i class="fas fa-play"></i><span class="btn-text">æ’­æ”¾</span>
            </button>
            <button class="dj-btn dj-next-btn" title="ä¸‹ä¸€ç« ">
                <i class="fas fa-forward-step"></i><span class="btn-text">ä¸‹ä¸€ç« </span>
            </button>
        </div>

        <div class="dj-progress">
            <div class="dj-time-display">
                <span id="dj-current-time">00:00</span>
                <span id="dj-duration">00:00</span>
            </div>
            <div class="dj-progress-bar"><div class="dj-progress-fill" id="dj-progress-fill"></div></div>
        </div>

        <div class="dj-visualizer" id="dj-visualizer"></div>

        <div class="dj-secondary-controls">
            <button class="dj-btn dj-speed-btn" id="dj-speed-btn" title="æ’­æ”¾é€Ÿåº¦">
                <i class="fas fa-gauge-high"></i><span class="btn-text">1x</span>
            </button>
            <button class="dj-btn dj-theme-btn" title="åˆ‡æ¢ä¸»é¢˜">
                <i class="fas fa-palette"></i><span class="btn-text">ä¸»é¢˜</span>
            </button>
            <button class="dj-btn dj-font-btn dj-font-minus" title="å‡å°å­—ä½“">
                <i class="fas fa-font"></i><span class="btn-text">A-</span>
            </button>
            <button class="dj-btn dj-font-btn dj-font-plus" title="å¢å¤§å­—ä½“">
                <i class="fas fa-font"></i><span class="btn-text">A+</span>
            </button>
            <button class="dj-btn dj-home-btn" title="è¿”å›é¦–é¡µ">
                <i class="fas fa-home"></i><span class="btn-text">é¦–é¡µ</span>
            </button>
        </div>
    </div>

    <button id="dj-toggle-btn" class="dj-btn dj-toggle-btn">
        <i class="fas fa-eye"></i><span class="btn-text">æ˜¾ç¤º/éšè—</span>
    </button>

    <!-- éŸ³é¢‘å…ƒç´  -->
    <audio id="chapter-audio" preload="auto" playsinline crossorigin="anonymous"></audio>

    <!-- åŸæœ‰é€»è¾‘ -->
    <script src="js/reader3.js"></script>

    <!-- é”å±æ’­æ”¾æ”¯æŒæ ¸å¿ƒä»£ç  -->
  <script>
  // ============================================================
  // ğŸ”Š é”å±æ’­æ”¾ & åå°æ’­æ”¾æ”¯æŒï¼ˆæœ€ç»ˆä¿®æ­£ç‰ˆï¼‰
  // ============================================================
  class LockScreenPlayback {
    constructor() {
      this.audio = document.getElementById('chapter-audio');
      this.init();
    }

    init() {
      console.log('ğŸš€ åˆå§‹åŒ–é”å±æ’­æ”¾æ”¯æŒ...');
      this.initMediaSession();
      this.initEvents();
      this.restoreState();
      console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
    }

    initMediaSession() {
      if (!('mediaSession' in navigator)) return;
      this.updateMetadata();
      ['play', 'pause', 'previoustrack', 'nexttrack'].forEach(action => {
        try {
          navigator.mediaSession.setActionHandler(action, () => this.handleAction(action));
        } catch {}
      });
    }

    handleAction(action) {
      switch(action) {
        case 'play': this.audio.play(); break;
        case 'pause': this.audio.pause(); break;
        case 'previoustrack':
          window.ReaderApp?.changeChapter?.(-1); break;
        case 'nexttrack':
          window.ReaderApp?.changeChapter?.(1); break;
      }
      this.saveState();
    }

    updateMetadata() {
      if (!('mediaSession' in navigator)) return;
      const bookTitle = document.getElementById('bookTitle')?.textContent || 'Awvâ€™sæ¼†ä¹¦';
      const chapterTitle = document.getElementById('dj-chapter-title')?.textContent || 'ç« èŠ‚';
      navigator.mediaSession.metadata = new MediaMetadata({
        title: `${bookTitle} - ${chapterTitle}`,
        artist: 'Awv æœ—è¯»å™¨',
        album: 'Awvâ€™sæ¼†ä¹¦',
        artwork: [
          { src: 'icons/icon-192x192.png', sizes: '192x192', type: 'image/png' },
          { src: 'icons/icon-512x512.png', sizes: '512x512', type: 'image/png' }
        ]
      });
    }

    initEvents() {
      // ä¸å†æš‚åœéŸ³é¢‘ï¼Œä»…æç¤ºç”¨æˆ·
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) this.showNotification();
      });
      this.audio.addEventListener('play', () => {
        if ('mediaSession' in navigator) navigator.mediaSession.playbackState = 'playing';
        this.saveState();
      });
      this.audio.addEventListener('pause', () => {
        if ('mediaSession' in navigator) navigator.mediaSession.playbackState = 'paused';
        this.saveState();
      });
      window.addEventListener('beforeunload', () => this.saveState());
      setInterval(() => this.saveState(), 10000);
    }

    showNotification() {
      const el = document.getElementById('background-play-notification');
      if (!el) return;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 3000);
    }

    saveState() {
      const s = {
        currentTime: this.audio.currentTime,
        isPlaying: !this.audio.paused,
        rate: this.audio.playbackRate,
        volume: this.audio.volume,
        ts: Date.now(),
        book: window.bookFolder || 'dev1',
        chapter: window.chapterNum || 'cover'
      };
      localStorage.setItem('lockScreenPlayState', JSON.stringify(s));
    }

    restoreState() {
      try {
        const s = JSON.parse(localStorage.getItem('lockScreenPlayState') || '{}');
        if (!s.ts || Date.now() - s.ts > 3600000) return;
        this.audio.currentTime = s.currentTime || 0;
        this.audio.playbackRate = s.rate || 1;
        this.audio.volume = s.volume || 1;
      } catch {}
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    window.lockScreenPlayback = new LockScreenPlayback();
    window.updateMediaSessionMetadata = () => lockScreenPlayback.updateMetadata();
  });

  // ============================================================
  // âœ… Service Worker æ³¨å†Œ (PWA å¿…é¡»)
  // ============================================================
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const swPath = window.location.pathname.includes('/js/') ? '../sw.js' : '/sw.js';
        const reg = await navigator.serviceWorker.register(swPath);
        console.log('âœ… Service Worker æ³¨å†ŒæˆåŠŸ:', reg.scope);
      } catch (e) {
        console.error('âŒ Service Worker æ³¨å†Œå¤±è´¥:', e);
      }
    });
  }
  </script>
</body>
</html>
